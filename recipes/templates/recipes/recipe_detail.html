{% extends "base.html" %}
{% block title %}{{ recipe.title }}{% endblock %}
{% block content %}
<article>
  <h1>{{ recipe.title }}</h1>
  <p class="text-muted">by {{ recipe.author.username }} • {{ recipe.created_at|date:"M d, Y" }}</p>
  {% if r.image %}
  <img src="{{ r.image.url }}" class="card-img-top" alt="{{ r.title }}">
  {% endif %}

  <p class="mt-3">{{ recipe.description }}</p>

  <h4>Ingredients</h4>
  <ul>
    {% for line in recipe.ingredients.splitlines %}
    {% if line %}<li>{{ line }}</li>{% endif %}
    {% endfor %}
  </ul>

  <h4>Steps</h4>
  <ol>
    {% for line in recipe.steps.splitlines %}
    {% if line %}<li>{{ line }}</li>{% endif %}
    {% endfor %}
  </ol>

  <p class="mt-3">Average rating: {{ recipe.average_rating }}★</p>
  {% if user.is_authenticated %}
  <form method="post" id="rating-form" class="mb-3 d-flex align-items-center">
    {% csrf_token %}
    <label class="me-2 mb-0">Your rating:</label>
    <div id="star-input" class="me-2">
      {% for i in "12345" %}
        {# render radio buttons visually as stars via CSS/JS #}
  <input type="radio" name="rating" id="star-{{ forloop.counter }}" value="{{ forloop.counter }}" {% if user_rating and user_rating.stars == forloop.counter %}checked{% endif %} style="display:none;">
  <label for="star-{{ forloop.counter }}" class="star-label" data-value="{{ forloop.counter }}" tabindex="0" role="button" aria-label="Rate {{ forloop.counter }} stars">★</label>
      {% endfor %}
    </div>
    <button class="btn btn-sm btn-outline-primary" type="submit">Submit</button>
  </form>
  {% else %}
  <p><a href="{% url 'login' %}">Log in</a> to rate this recipe.</p>
  {% endif %}
  <h4 class="mt-4">Comments</h4>
  {% if comments %}
  <ul class="list-group mb-4">
    {% for c in comments %}
    <li class="list-group-item">
      <strong>{{ c.user.username }}</strong>
      <span class="text-muted small"> • {{ c.created_at|date:"M d, Y H:i" }}</span>
      <p class="mb-1">{{ c.body }}</p>
    </li>
    {% endfor %}
  </ul>
  {% else %}
  <p class="text-muted">No comments yet.</p>
  {% endif %}

  {% if user.is_authenticated %}
  <hr class="my-4">
  <h5 class="mb-3">Add a comment</h5>
  <form method="post" class="mb-5">
    {% csrf_token %}
    {{ comment_form.body }}
    <div class="mt-2">
      <button class="btn btn-primary btn-sm">Post comment</button>
    </div>
  </form>
  {% else %}
  <p class="mt-3">
    <a href="{% url 'login' %}">Log in</a> to add a comment.
  </p>
  {% endif %}

</article>
{% endblock %}

{% if user.is_authenticated %}
<script>
  document.addEventListener('DOMContentLoaded', function () {
    var starInput = document.getElementById('star-input');
    if (!starInput) return;
    var labels = starInput.querySelectorAll('.star-label');
    var radios = starInput.querySelectorAll('input[type="radio"][name="rating"]');

    var pendingValue = null; // tentative selection while hovering/tapping

    function setSelected(value) {
      labels.forEach(function(lbl){
        var v = parseInt(lbl.getAttribute('data-value'));
        if (v <= value) lbl.classList.add('selected'); else lbl.classList.remove('selected');
      });
    }

    labels.forEach(function(lbl){
      // click selects and persists selection
      lbl.addEventListener('click', function(e){
        var v = parseInt(this.getAttribute('data-value'));
        var r = document.getElementById('star-' + v);
        if (r) r.checked = true;
        pendingValue = v;
        setSelected(v);
      });

      // hover (desktop) — set pending selection on mouseenter
      lbl.addEventListener('mouseenter', function(e){
        var v = parseInt(this.getAttribute('data-value'));
        pendingValue = v;
        setSelected(v);
      });

      // touch devices — set pending selection on touchstart
      lbl.addEventListener('touchstart', function(e){
        var v = parseInt(this.getAttribute('data-value'));
        pendingValue = v;
        setSelected(v);
      }, {passive: true});

      // keyboard accessibility: Enter or Space should toggle and persist
      lbl.addEventListener('keydown', function(e){
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          this.click();
        }
      });
    });
    starInput.addEventListener('mouseleave', function(){
      // keep pendingValue if present; otherwise restore checked state
      if (pendingValue !== null) {
        setSelected(pendingValue);
        return;
      }
      var checked = Array.from(radios).find(function(r){ return r.checked; });
      var val = checked ? parseInt(checked.value) : 0;
      setSelected(val);
    });

    // clicking outside clears pending selection (reverts to checked)
    document.addEventListener('click', function(e){
      if (!starInput.contains(e.target)) {
        pendingValue = null;
        var checked = Array.from(radios).find(function(r){ return r.checked; });
        var val = checked ? parseInt(checked.value) : 0;
        setSelected(val);
      }
    });

    // Escape cancels pending selection
    document.addEventListener('keydown', function(e){
      if (e.key === 'Escape') {
        pendingValue = null;
        var checked = Array.from(radios).find(function(r){ return r.checked; });
        var val = checked ? parseInt(checked.value) : 0;
        setSelected(val);
      }
    });

    // ensure submit applies pendingValue to the radio before posting
    var form = document.getElementById('rating-form');
    if (form) {
      form.addEventListener('submit', function(e){
        if (pendingValue !== null) {
          var r = document.getElementById('star-' + pendingValue);
          if (r) r.checked = true;
        }
        // allow form to submit normally
      });
    }
    // initialize from checked
    var initChecked = Array.from(radios).find(function(r){ return r.checked; });
    if (initChecked) setSelected(parseInt(initChecked.value));
  });
</script>
{% endif %}